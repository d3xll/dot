#!/bin/bash
# ═══════════════════════════════════════════════════════════════
# Papirus Dynamic Color Matcher for Matugen
# ═══════════════════════════════════════════════════════════════

# Проверка аргумента
if [[ -z "$1" ]]; then
    echo "Usage: papirus-dynamic <hex_color>"
    echo "Example: papirus-dynamic 8b5cf6"
    exit 1
fi

INPUT_COLOR="${1#\#}"  # Убираем # если есть

# ─────────────────────────────────────────────────────────────────
# Цвета Papirus (HEX без #)
# https://github.com/PapirusDevelopmentTeam/papirus-folders
# ─────────────────────────────────────────────────────────────────
declare -A PAPIRUS_COLORS=(
    ["adwaita"]="3584e4"
    ["black"]="4f4f4f"
    ["blue"]="5294e2"
    ["bluegrey"]="607d8b"
    ["breeze"]="5c8dca"
    ["brown"]="ae8e6c"
    ["carmine"]="b02640"
    ["cyan"]="00bcd4"
    ["darkcyan"]="008ba7"
    ["deeporange"]="ff6e40"
    ["green"]="87b158"
    ["grey"]="8e8e8e"
    ["indigo"]="5c6bc0"
    ["magenta"]="ca5183"
    ["nordic"]="5e81ac"
    ["orange"]="f9a03f"
    ["palebrown"]="c4a988"
    ["paleorange"]="e6a679"
    ["pink"]="f06292"
    ["red"]="e25252"
    ["teal"]="009688"
    ["violet"]="7e57c2"
    ["white"]="e4e4e4"
    ["yaru"]="e95420"
    ["yellow"]="ffcc00"
)

# ─────────────────────────────────────────────────────────────────
# Функция: HEX → RGB
# ─────────────────────────────────────────────────────────────────
hex_to_rgb() {
    local hex="$1"
    echo "$((16#${hex:0:2})) $((16#${hex:2:2})) $((16#${hex:4:2}))"
}

# ─────────────────────────────────────────────────────────────────
# Функция: RGB → LAB (для лучшего сравнения цветов)
# ─────────────────────────────────────────────────────────────────
rgb_to_lab() {
    local r=$1 g=$2 b=$3
    
    # Нормализация RGB
    local nr=$(echo "scale=10; $r / 255" | bc)
    local ng=$(echo "scale=10; $g / 255" | bc)
    local nb=$(echo "scale=10; $b / 255" | bc)
    
    # Гамма-коррекция
    gamma_correct() {
        local v=$1
        echo "scale=10; if ($v > 0.04045) ((($v + 0.055) / 1.055) ^ 2.4) else ($v / 12.92)" | bc -l
    }
    
    nr=$(gamma_correct $nr)
    ng=$(gamma_correct $ng)
    nb=$(gamma_correct $nb)
    
    # RGB → XYZ
    local x=$(echo "scale=10; ($nr * 0.4124564 + $ng * 0.3575761 + $nb * 0.1804375) / 0.95047" | bc)
    local y=$(echo "scale=10; ($nr * 0.2126729 + $ng * 0.7151522 + $nb * 0.0721750) / 1.00000" | bc)
    local z=$(echo "scale=10; ($nr * 0.0193339 + $ng * 0.1191920 + $nb * 0.9503041) / 1.08883" | bc)
    
    # XYZ → LAB
    f_lab() {
        local t=$1
        echo "scale=10; if ($t > 0.008856) ($t ^ (1/3)) else (7.787 * $t + 16/116)" | bc -l
    }
    
    local fx=$(f_lab $x)
    local fy=$(f_lab $y)
    local fz=$(f_lab $z)
    
    local L=$(echo "scale=6; 116 * $fy - 16" | bc)
    local a=$(echo "scale=6; 500 * ($fx - $fy)" | bc)
    local b_lab=$(echo "scale=6; 200 * ($fy - $fz)" | bc)
    
    echo "$L $a $b_lab"
}

# ─────────────────────────────────────────────────────────────────
# Функция: Евклидово расстояние между цветами (упрощённая)
# ─────────────────────────────────────────────────────────────────
color_distance() {
    local hex1="$1"
    local hex2="$2"
    
    read r1 g1 b1 <<< $(hex_to_rgb "$hex1")
    read r2 g2 b2 <<< $(hex_to_rgb "$hex2")
    
    # Взвешенное расстояние (человеческое восприятие)
    local rmean=$(( (r1 + r2) / 2 ))
    local dr=$(( r1 - r2 ))
    local dg=$(( g1 - g2 ))
    local db=$(( b1 - b2 ))
    
    # Формула redmean для лучшего соответствия восприятию
    local dist=$(echo "scale=2; sqrt((2 + $rmean/256) * $dr^2 + 4 * $dg^2 + (2 + (255-$rmean)/256) * $db^2)" | bc)
    echo "$dist"
}

# ─────────────────────────────────────────────────────────────────
# Поиск ближайшего цвета
# ─────────────────────────────────────────────────────────────────
ind_closest_color() {
    local input_hex="$1"
    local min_dist=99999
    local closest_name=""
    
    for name in "${!PAPIRUS_COLORS[@]}"; do
        local papirus_hex="${PAPIRUS_COLORS[$name]}"
        local dist=$(color_distance "$input_hex" "$papirus_hex")
        
        if (( $(echo "$dist < $min_dist" | bc -l) )); then
            min_dist="$dist"
            closest_name="$name"
        fi
    done
    
    echo "$closest_name"
}

# ─────────────────────────────────────────────────────────────────
# Основная логика
# ─────────────────────────────────────────────────────────────────

CLOSEST=$(find_closest_color "$INPUT_COLOR")

echo "═══════════════════════════════════════════════════"
echo "  Papirus Dynamic Icons"
echo "═══════════════════════════════════════════════════"
echo "  Input color:   #$INPUT_COLOR"
echo "  Matched color: $CLOSEST (#${PAPIRUS_COLORS[$CLOSEST]})"
echo "═══════════════════════════════════════════════════"

# Применение цвета
if command -v papirus-folders &> /dev/null; then
    papirus-folders -C "$CLOSEST" --theme Papirus-Dark
    echo "  ✓ Applied successfully!"
else
    echo "  ✗ Error: papirus-folders not found"
    echo "  Install: yay -S papirus-folders-git"
    exit 1
fi

# Лог для отладки
echo "[$(date '+%Y-%m-%d %H:%M:%S')] #$INPUT_COLOR → $CLOSEST" >> ~/.cache/papirus-dynamic.log